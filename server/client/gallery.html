<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>Gallery</title>
		<link href="./assets/css/style.css" rel="stylesheet" type="text/css" />
		<script type="text/javascript" async src="./assets/js/protobuf.js"></script>
		<script type="text/javascript" async src="./assets/js/sequence.js"></script>
		<script type="text/javascript" async src="./assets/js/message.js"></script>
		<script>
			window.onload = function ()
			{
				var s = new sequence ();
				s.add ("init", function (objs, canNext)
				{
					if (!document.body)
					{
						canNext (false);
						return;
					}

					canNext (true);
					objs.protos = {};
					objs.imgCodes = {
						"bmp": "image/bmp",
						"gif": "image/gif",
						"jpg": "image/jpeg",
						"jpeg": "image/jpeg",
						"png": "image/png",
						"svg": "image/svg+xml",
						"tif": "image/tiff",
						"tiff": "image/tiff"
					};
					objs.message = new message ();

				}).add ("parse_proto_cmd", function (objs, canNext)
				{					
					protobuf.load ("./protos/cmd.proto", function (error, cmd)
					{
						if (error)
						{
							canNext (false);
							throw error;
						}
						
						objs.protos.cmd = cmd;
						canNext (true);
					});
				}).add ("parse_proto_model", function (objs, canNext)
				{					
					protobuf.load ("./protos/model.proto", function (error, model)
					{
						if (error)
						{
							canNext (false);
							throw error;
						}

						objs.protos.model = model;
						canNext (true);
					});
				}).add ("build_request", function (objs, canNext)
				{
					var content = {
						id: "1"
					};
					
					var buffer = objs.message.encode (objs.protos.cmd, "requestComic", content);
					if (!buffer)
					{
						canNext (false);
						return;
					}

					objs.request = buffer;
					canNext (true);
					
				}).add ("send_request", function (objs, canNext)
				{
					var XHR = new XMLHttpRequest();
					
					// Define what happens on successful data submission
					XHR.addEventListener('load', (event) => {});
					XHR.onload = function ()
					{
						objs.response = XHR.response;
						canNext (true);
					}

					// Define what happens in case of error
					XHR.addEventListener('error', function (event)
					{
						console.log('Oops! Something goes wrong.');
						canNext (false);
					});

					// Set up our request
					XHR.open('POST', 'http://localhost:4200/request');
					XHR.setRequestHeader('Content-Type', 'application/octet-stream');
					XHR.responseType = "arraybuffer";
					XHR.send(objs.request);
				}).add ("parse_response", function (objs, canNext)
				{
					var message = objs.message.decode (objs.protos.cmd, objs.response);
					if (!message)
					{
						canNext (false);
						return;
					}
					objs.reponseMsg = message;
					canNext (true);
				}).add ("render", function (objs, canNext)
				{
					let data = objs.reponseMsg.comic;
					let galleryData = data.gallery;
					
					let galleryElement = document.createElement ("div");
					galleryElement.className = "gallery";

					document.title = "Hourou Musuko - Chapter 1 - " + data.name;
					document.body.appendChild(galleryElement); 

					galleryData.forEach (image =>
					{
						let nameParts = image.name.split (".");
						let canvas = document.createElement ("canvas");
						let context = canvas.getContext("2d");
						let img = new Image();
						img.onload = () => {
							canvas.setAttribute ("alt", nameParts[0]);
							canvas.height = img.naturalHeight;
							canvas.width = img.naturalWidth;
							context.drawImage (img, 0, 0);
						};
						img.src = "data:" + objs.imgCodes [nameParts[1]] + ";base64, " + image.url;
						galleryElement.appendChild (canvas);
					});
					
					canNext (true);
				}).run();
			}
		</script>
	</head>
	<body>
	</body>
</html>